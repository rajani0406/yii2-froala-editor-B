name: Auto Release on Merge

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main

  workflow_run:
    workflows: ["Sync Version from Main Repo"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:

  validate_pr:
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest

    steps:
      - name: Check commit messages for release flag
        id: validate
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            const hasRelease = commits.data.some(c =>
              /release:\s*yes/i.test(c.commit.message)
            );

            core.setOutput("valid", hasRelease ? "true" : "false");

      - name: Fail if no release flag
        if: steps.validate.outputs.valid == 'false'
        run: |
          echo "PR missing 'release: yes' in commit message"
          exit 1


  create_release:
    # Only run when PR merged AND release flag exists
    if: >
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      (
        contains(github.event.pull_request.title, 'release: yes') ||
        contains(github.event.pull_request.body, 'release: yes')
      )
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Read version from composer.json
        id: version
        run: |
          VERSION=$(jq -r '.version' composer.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "v${{ env.VERSION }}"
          release_name: "Release v${{ env.VERSION }}"
          body: "Auto-release for version v${{ env.VERSION }}"
